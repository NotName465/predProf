<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Администратор — Столовая Школа 2098</title>
    <style>
        * { margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Times New Roman', sans-serif;}
        body { background: linear-gradient(135deg, #e3f2fd, #ffffff);
        color: #333; min-height: 100vh;
        padding-top: 70px;}

        .shapka {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .menu-toggle {
            display: none;
            background: #2196F3;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
        }

        .title {
            color: #0d47a1;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            flex-grow: 1;
            margin: 0 10px;
        }

        .main-layout {
            display: flex;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px 30px;
        }

        .left-panel {
            width: 220px;
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .prof {
            background: #2196F3;
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            box-shadow: 0 2px 6px rgba(33, 150, 243, 0.3);
        }

        .head {
            margin-bottom: 20px;
            padding: 10px;
            background: #e3f2fd;
            color: #0d47a1;
            border-radius: 10px;
            text-align: center;
            width: 100%;
        }

        .head h1 {
            font-size: 18px;
            margin: 0;
            font-weight: bold;
        }

        .tabs {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }

        .tab-btn {
            padding: 12px;
            border: none;
            background: #f5f9ff;
            border-radius: 12px;
            cursor: pointer;
            text-align: left;
            font-weight: bold;
            color: #555;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: #d0e6ff;
        }

        .tab-btn.active {
            background: #2196F3;
            color: white;
        }

        .center-content {
            flex: 1;
            display: flex;
            justify-content: center;
        }

        .content {
            width: 100%;
            max-width: 800px;
        }

        .tab-content {
            display: none;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .tab-content.active {
            display: block;
        }

        h2 {
            color: #0d47a1;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f8fbff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #2196F3;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #0d47a1;
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }


        .request-card {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .request-title {
            font-weight: bold;
            color: #0d47a1;
            font-size: 16px;
        }

        .request-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-approved {
            background: #e8f5e9;
            color: #388e3c;
        }

        .status-rejected {
            background: #ffebee;
            color: #c62828;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            border: none;
        }

        .btn-approve {
            background: #4caf50;
            color: white;
        }

        .btn-reject {
            background: #f44336;
            color: white;
        }

        .btn-neutral {
            background: #757575;
            color: white;
        }

        input, button, select, textarea {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
        }

        button {
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th {
            background: #e3f2fd;
            color: #0d47a1;
            text-align: left;
            padding: 12px;
            font-weight: bold;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f5f9ff;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            color: #f44336;
            text-align: center;
            padding: 20px;
        }

        /* Адаптивка */
        @media (max-width: 768px) {
            .shapka {
                padding: 12px 15px;
            }

            .title {
                font-size: 18px;
            }

            .menu-toggle {
                display: block;
            }

            .left-panel {
                position: fixed;
                top: 70px;
                left: -250px;
                height: calc(100vh - 70px);
                z-index: 90;
                transition: left 0.3s ease;
                width: 230px;
                padding: 20px;
                border-radius: 0 16px 16px 0;
            }

            .left-panel.open {
                left: 0;
            }

            .main-layout {
                display: block;
                padding: 0 10px 20px;
            }

            .center-content {
                margin-top: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        .toast {
        position: fixed; top: 20px; right: 20px;
        background: #333; color: white;
        padding: 15px 25px; border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        z-index: 9999; animation: slideIn 0.3s ease-out;
        cursor: pointer;
    }
    .toast:hover { background: #444; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>

    <header class="shapka">
        <button class="menu-toggle" id="menuToggle">Меню</button>
        <h1 class="title">Столовая — Школа 2098</h1>
        <div style="font-weight: bold; color: #0d47a1;">Администратор</div>
    </header>

    <div class="main-layout">
        <aside class="left-panel" id="leftPanel">
            <button class="prof" onclick="window.location.href='/logout'">В</button>
            <header class="head">
                <h1>Панель администратора</h1>
            </header>
            <nav class="tabs">
                <button class="tab-btn active" data-tab="stats">Статистика</button>
                <button class="tab-btn" data-tab="requests">Закупки</button>
                <button class="tab-btn" data-tab="reports">Отчёты</button>
                <button class="tab-btn" data-tab="users">Пользователи</button>
                <button class="tab-btn" data-tab="menu">Меню</button>
            </nav>
        </aside>

        <div class="center-content">
            <main class="content">
                <div id="stats" class="tab-content active">
                    <h2>Статистика системы</h2>
                    <div id="statsLoading" class="loading">Загрузка...</div>
                    <div id="statsContainer" style="display: none;">
                        <div class="stats-grid">
                            <div class="stat-card"><div class="stat-label">Посетителей сегодня</div><div class="stat-value" id="attendanceToday">0</div></div>
                            <div class="stat-card"><div class="stat-label">Выручка сегодня</div><div class="stat-value" id="revenueToday">0 ₽</div></div>
                            <div class="stat-card"><div class="stat-label">Всего выдано</div><div class="stat-value" id="totalIssued">0</div></div>
                            <div class="stat-card"><div class="stat-label">Активных подписок</div><div class="stat-value" id="activeSubscriptions">0</div></div>
                        </div>
                        <h3 style="margin-top: 30px; color: #0d47a1;">Популярные блюда (сегодня)</h3>
                        <div id="dishesChart" style="margin-top: 10px;"></div>
                    </div>
                </div>

                <div id="requests" class="tab-content">
                    <h2>Заявки на закупку</h2>
                    <div id="requestsLoading" class="loading">Загрузка...</div>
                    <div id="requestsContainer" style="display: none;">
                        <p id="noRequests" style="text-align: center; color: #666; display: none;">Нет новых заявок.</p>
                        <div id="requestsList"></div>
                    </div>
                </div>

                <div id="reports" class="tab-content">
                    <h2>Финансовые отчёты</h2>
                    <div id="reportsLoading" class="loading">Загрузка...</div>
                    <div id="reportsContainer" style="display: none; overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Дата</th>
                                    <th>Выручка</th>
                                    <th>Транзакций</th>
                                </tr>
                            </thead>
                            <tbody id="reportsTable"></tbody>
                        </table>
                    </div>
                </div>

                <div id="users" class="tab-content">
                    <h2>Пользователи</h2>
                    <input type="text" id="searchUser" placeholder="Поиск..." style="margin-bottom: 20px;">
                    <div id="usersLoading" class="loading">Загрузка...</div>
                    <div id="usersList"></div>
                </div>

                <div id="menu" class="tab-content">
                    <h2>Меню столовой</h2>
                    <div id="menuManagementContainer"></div>
                </div>
            </main>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <div class="action-buttons">
                <button class="btn-small btn-approve" id="modalConfirmBtn">Да</button>
                <button class="btn-small btn-neutral" onclick="closeModal()">Нет</button>
            </div>
        </div>
    </div>

    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <h3>Изменить роль</h3>
            <p id="editUserName" style="margin-bottom:15px; color:#555;"></p>
            <input type="hidden" id="editUserId">
            <select id="newRoleSelect" style="margin-bottom:20px;">
                <option value="student">Ученик</option>
                <option value="cook">Повар</option>
                <option value="admin">Администратор</option>
            </select>
            <div class="action-buttons">
                <button class="btn-small btn-approve" onclick="saveUserRole()">Сохранить</button>
                <button class="btn-small btn-neutral" onclick="document.getElementById('editUserModal').style.display='none'">Отмена</button>
            </div>
        </div>
    </div>

    <script>
        let currentRequestId = null;
        let currentAction = null;

        document.addEventListener('DOMContentLoaded', () => {
            setupTabs();
            setupMobileMenu();
            loadStats();
            setupSearch();
        });

        function setupTabs() {
            const btns = document.querySelectorAll('.tab-btn');
            btns.forEach(btn => {
                btn.addEventListener('click', () => {
                    btns.forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                    btn.classList.add('active');
                    const id = btn.getAttribute('data-tab');
                    document.getElementById(id).classList.add('active');

                    if(id === 'stats') loadStats();
                    if(id === 'requests') loadRequests();
                    if(id === 'reports') loadReports();
                    if(id === 'users') loadUsers();
                    if(id === 'menu') loadMenu();
                });
            });
        }

        function setupMobileMenu() {
            const toggle = document.getElementById('menuToggle');
            const panel = document.getElementById('leftPanel');
            toggle.addEventListener('click', () => panel.classList.toggle('open'));

            document.addEventListener('click', (e) => {
                if(!panel.contains(e.target) && e.target !== toggle) {
                    panel.classList.remove('open');
                }
            });
        }

        async function loadStats() {
            try {
                const res = await fetch('/api/admin/stats');
                const data = await res.json();
                if(res.ok) {
                    document.getElementById('statsLoading').style.display = 'none';
                    document.getElementById('statsContainer').style.display = 'block';

                    document.getElementById('attendanceToday').textContent = data.attendance_today || 0;
                    document.getElementById('revenueToday').textContent = (data.revenue_today || 0) + ' ₽';
                    document.getElementById('totalIssued').textContent = data.total_issued || 0;

                    const subRes = await fetch('/api/admin/active-subscriptions');
                    const subData = await subRes.json();
                    document.getElementById('activeSubscriptions').textContent = subData.count || 0;

                    loadPopular();
                }
            } catch(e) {
                console.error('Ошибка загрузки статистики:', e);
            }
        }

        async function loadPopular() {
            const res = await fetch('/api/admin/popular-dishes');
            const data = await res.json();
            const container = document.getElementById('dishesChart');

            if(data.length) {
                container.innerHTML = data.map(d => `
                    <div style="margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; font-size: 14px;">
                            <span>${d.name}</span>
                            <span>${d.count} шт</span>
                        </div>
                        <div style="height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
                            <div style="height: 100%; width: ${d.percentage}%; background: #2196F3;"></div>
                        </div>
                    </div>`).join('');
            } else {
                container.innerHTML = '<p>Нет данных</p>';
            }
        }

        async function loadRequests() {
            const res = await fetch('/api/purchase_requests');
            const data = await res.json();

            document.getElementById('requestsLoading').style.display = 'none';
            document.getElementById('requestsContainer').style.display = 'block';

            const list = document.getElementById('requestsList');
            if(!data.length) {
                document.getElementById('noRequests').style.display = 'block';
                list.innerHTML = '';
                return;
            }

            document.getElementById('noRequests').style.display = 'none';
            list.innerHTML = data.map(r => {
                const statusMap = {'pending':'Ожидает', 'approved':'Одобрено', 'rejected':'Отклонено'};
                return `
                <div class="request-card">
                    <div class="request-header">
                        <div class="request-title">${r.ingredient_name}</div>
                        <span class="request-status status-${r.status}">${statusMap[r.status]||r.status}</span>
                    </div>
                    <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                        Кол-во: ${r.quantity} ${r.unit} | От: ${r.requester} | Дата: ${new Date(r.request_date).toLocaleDateString()}
                    </div>
                    ${r.status === 'pending' ?
                        `<div class="action-buttons">
                            <button class="btn-small btn-approve" onclick="confirmRequest(${r.id}, 'approve')">Одобрить</button>
                            <button class="btn-small btn-reject" onclick="confirmRequest(${r.id}, 'reject')">Отклонить</button>
                        </div>` :
                        ''}
                </div>`;
            }).join('');
        }

        function confirmRequest(id, action) {
            currentRequestId = id;
            currentAction = action;
            const title = action === 'approve' ? 'Одобрить?' : 'Отклонить?';
            const message = action === 'approve' ? 'Ингредиенты будут добавлены на склад.' : 'Заявка будет отклонена.';
            showModal(title, message, 'Подтвердить');
        }

        async function confirmAction() {
            if (!currentRequestId) return;
            const status = currentAction === 'approve' ? 'approved' : 'rejected';

            await fetch(`/api/purchase_requests/${currentRequestId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({status})
            });

            closeModal();
            loadRequests();
        }

        async function loadReports() {
            const res = await fetch('/api/admin/reports');
            const data = await res.json();

            document.getElementById('reportsLoading').style.display = 'none';
            document.getElementById('reportsContainer').style.display = 'block';

            document.getElementById('reportsTable').innerHTML = data.length ?
                data.map(r => `
                    <tr>
                        <td>${new Date(r.date).toLocaleDateString()}</td>
                        <td>${r.revenue} ₽</td>
                        <td>${r.transactions}</td>
                    </tr>`).join('') :
                '<tr><td colspan="3" style="text-align:center">Нет данных</td></tr>';
        }

        async function loadUsers() {
            const res = await fetch('/api/admin/users');
            const users = await res.json();

            document.getElementById('usersLoading').style.display = 'none';
            document.getElementById('usersList').innerHTML = users.map(u => `
                <div class="request-card" style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold; color:#0d47a1;">${u.username}
                            <span style="font-size:12px; background:#eee; padding:2px 6px; border-radius:4px;">${u.role}</span>
                        </div>
                        <div style="font-size:13px; color:#666;">${u.email} | Заказов: ${u.total_orders}</div>
                    </div>
                    <button class="btn-small btn-neutral" onclick="editUser(${u.id}, '${u.username}')">Роль</button>
                </div>`).join('');
        }

        function editUser(id, name) {
            document.getElementById('editUserId').value = id;
            document.getElementById('editUserName').textContent = name;
            document.getElementById('editUserModal').style.display = 'flex';
        }

        async function saveUserRole() {
            const id = document.getElementById('editUserId').value;
            const role = document.getElementById('newRoleSelect').value;

            await fetch(`/api/admin/users/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({role})
            });

            document.getElementById('editUserModal').style.display = 'none';
            loadUsers();
        }

        function setupSearch() {
            document.getElementById('searchUser').addEventListener('input', function() {
                const term = this.value.toLowerCase();
                document.querySelectorAll('#usersList .request-card').forEach(card => {
                    card.style.display = card.innerText.toLowerCase().includes(term) ? 'flex' : 'none';
                });
            });
        }

        async function loadMenu() {
            const res = await fetch('/api/dishes');
            const dishes = await res.json();
            document.getElementById('menuManagementContainer').innerHTML = dishes.map(d => `
                <div class="request-card">
                    <div style="font-weight:bold; color:#0d47a1;">${d.name}</div>
                    <div style="font-size:13px;">${d.calories} ккал | ${d.price} ₽ | Остаток: ${d.stock_quantity}</div>
                </div>`).join('');
        }

        function showModal(title, msg, btnText) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = msg;
            document.getElementById('modalConfirmBtn').textContent = btnText;
            document.getElementById('confirmModal').style.display = 'flex';
            document.getElementById('modalConfirmBtn').onclick = confirmAction;
        }

        function closeModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        function logout() {
            fetch('/logout').then(() => window.location.href = '/login');
        }
        let lastPendingCount = -1;

    function showNotification(count) {
        const old = document.getElementById('adminNotif');
        if (old) old.remove();

        const div = document.createElement('div');
        div.id = 'adminNotif';
        div.className = 'toast';
        div.innerHTML = `<b>Новые заявки: ${count}</b><br><span style="font-size:12px">Нажмите, чтобы посмотреть</span>`;

        div.onclick = () => {
            document.querySelector('[data-tab="requests"]').click();
            div.remove();
        };

        document.body.appendChild(div);

        setTimeout(() => { if(div.parentNode) div.remove(); }, 10000);
    }

     let lastShownCount = 0;

        setInterval(async () => {
            try {
                const r = await fetch('/api/notifications/admin');
                const d = await r.json();
                const count = d.pending_count;

                if(count > 0 && count > lastShownCount) {

                    let n = document.getElementById('notif');

                    if (!n) {
                        n = document.createElement('div');
                        n.id = 'notif';
                        n.style.cssText = "position:fixed; top:80px; right:20px; background:#2196F3; color:white; padding:15px 25px; border-radius:8px; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,0.3); z-index:9999; animation: slideIn 0.3s ease-out;";

                        n.onclick = () => {
                            document.querySelector('[data-tab="requests"]').click();
                            n.remove();

                        };
                        document.body.appendChild(n);
                    }

                    n.innerHTML = `<b>Новые заявки: ${count}</b><br><span style='font-size:12px'>Нажмите для просмотра</span>`;

                    lastShownCount = count;
                }
                else if (count < lastShownCount) {
                    lastShownCount = count;
                    if (count === 0) {
                        const n = document.getElementById('notif');
                        if (n) n.remove();
                    }
                }
            } catch(e){}
        }, 5000);
    </script>
</body>
</html>