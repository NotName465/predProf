<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Вход и регистрация — Столовая Школа 2098</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Candara, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #89a7bd, #ffffff);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 15px;
    }

    .forma_konteyner {
      background: white;
      padding: 30px 25px;
      border-radius: 20px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
      width: 100%;
      max-width: 480px;
      text-align: center;
    }

    .zagolovok_formy {
      color: #0d47a1;
      font-size: 22px;
      margin-bottom: 20px;
      font-weight: bold;
    }

    .gruppa_polei {
      margin-bottom: 20px;
      text-align: left;
    }

    .metka_poliya {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-size: 16px;
      font-weight: 500;
    }

    .pole_vvoda {
      width: 100%;
      padding: 14px;
      border: 1px solid #ccc;
      border-radius: 12px;
      font-size: 17px;
      transition: border-color 0.3s;
    }

    .pole_vvoda:focus {
      outline: none;
      border-color: #2196F3;
    }

    .knopka_formy {
      width: 100%;
      padding: 14px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      cursor: pointer;
      transition: background 0.3s;
      margin-top: 12px;
      min-height: 48px;
    }

    .knopka_formy:hover {
      background: #1976D2;
    }

    .pereklyuchatel {
      margin-top: 20px;
      font-size: 16px;
      color: #555;
    }

    .ssylka_pereklyucheniya {
      color: #2196F3;
      text-decoration: none;
      cursor: pointer;
      font-weight: bold;
      padding: 6px 0;
      display: inline-block;
    }

    .ssylka_pereklyucheniya:hover {
      text-decoration: underline;
    }

    .forma_skryta {
      display: none;
    }

    .spisok_allergenov {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
      margin-top: 10px;
      max-height: 200px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      background: #f9f9f9;
    }

    .flazok {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
      color: #444;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.2s;
    }

    .flazok:hover {
      background: #e3f2fd;
    }

    .flazok input[type="checkbox"] {
      margin: 0;
      transform: scale(1.3);
      min-width: 20px;
      min-height: 20px;
      cursor: pointer;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .error {
      color: #f44336;
      font-size: 14px;
      margin-top: 5px;
      display: none;
    }

    .message {
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      font-size: 14px;
    }

    .success {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .error-message {
      background: #ffebee;
      color: #c62828;
    }

    button, .knopka_formy, .ssylka_pereklyucheniya {
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      -webkit-appearance: none;
    }

    @media (max-width: 360px) {
      .spisok_allergenov {
        grid-template-columns: repeat(2, 1fr);
      }
      .zagolovok_formy {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>

  <div class="forma_konteyner">

    <div id="forma_vhoda">
      <div class="zagolovok_formy">Вход в систему</div>
      <div id="loginMessage" class="message" style="display: none;"></div>
      <form id="loginForm">
        <div class="gruppa_polei">
          <label class="metka_poliya" for="login">Логин или email</label>
          <input type="text" id="login" class="pole_vvoda" autocomplete="username" required>
          <div id="loginError" class="error"></div>
        </div>
        <div class="gruppa_polei">
          <label class="metka_poliya" for="parol">Пароль</label>
          <input type="password" id="parol" class="pole_vvoda" autocomplete="current-password" required>
          <div id="passwordError" class="error"></div>
        </div>
        <button type="submit" class="knopka_formy">Войти</button>
      </form>
      <div class="pereklyuchatel">
        Нет аккаунта? <span class="ssylka_pereklyucheniya" onclick="pokazat('registraciya')">Зарегистрироваться</span>
      </div>
    </div>

    <div id="forma_registracii" class="forma_skryta">
      <div class="zagolovok_formy">Регистрация</div>
      <div id="registerMessage" class="message" style="display: none;"></div>
      <form id="regForm">
        <div class="gruppa_polei">
          <label class="metka_poliya" for="imya">Имя</label>
          <input type="text" id="imya" class="pole_vvoda" autocomplete="name" required>
          <div id="nameError" class="error"></div>
        </div>
        <div class="gruppa_polei">
          <label class="metka_poliya" for="email">Email</label>
          <input type="email" id="email" class="pole_vvoda" autocomplete="email" required>
          <div id="emailError" class="error"></div>
        </div>
        <div class="gruppa_polei">
          <label class="metka_poliya" for="novyy_parol">Пароль</label>
          <input type="password" id="novyy_parol" class="pole_vvoda" autocomplete="new-password" required>
          <div id="passwordErrorReg" class="error"></div>
        </div>
        <div class="gruppa_polei">
          <label class="metka_poliya" for="povtor_parolya">Повторите пароль</label>
          <input type="password" id="povtor_parolya" class="pole_vvoda" autocomplete="new-password" required>
          <div id="confirmPasswordError" class="error"></div>
        </div>

        <div class="gruppa_polei">
          <div class="metka_poliya">Аллергены и непереносимости (опционально)</div>
          <p style="font-size: 14px; color: #666; margin-bottom: 10px;">Отметьте продукты, на которые у вас аллергия:</p>
          <div id="allergensLoading" class="loading">Загрузка списка аллергенов...</div>
          <div id="spisok_allergenov" class="spisok_allergenov" style="display: none;">
            <!-- Здесь будут загружены чекбоксы с аллергенами -->
          </div>
        </div>

        <button type="submit" class="knopka_formy" id="regButton">Зарегистрироваться</button>
      </form>
      <div class="pereklyuchatel">
        Уже есть аккаунт? <span class="ssylka_pereklyucheniya" onclick="pokazat('vhod')">Войти</span>
      </div>
    </div>
  </div>

  <script>
    // Функция переключения между формами
    function pokazat(formType) {
      const loginForm = document.getElementById('forma_vhoda');
      const registerForm = document.getElementById('forma_registracii');

      if (formType === 'vhod') {
        loginForm.classList.remove('forma_skryta');
        registerForm.classList.add('forma_skryta');
        clearMessages();
      } else if (formType === 'registraciya') {
        loginForm.classList.add('forma_skryta');
        registerForm.classList.remove('forma_skryta');
        clearMessages();
        loadAllergens(); // Загружаем аллергены при показе формы регистрации
      }
    }

    // Очистка сообщений
    function clearMessages() {
      document.querySelectorAll('.message').forEach(msg => {
        msg.style.display = 'none';
        msg.textContent = '';
        msg.className = 'message';
      });
      document.querySelectorAll('.error').forEach(error => {
        error.style.display = 'none';
        error.textContent = '';
      });
    }

    // Показать сообщение
    function showMessage(elementId, text, type) {
      const element = document.getElementById(elementId);
      element.textContent = text;
      element.className = `message ${type}`;
      element.style.display = 'block';
    }

    // Показать ошибку
    function showError(elementId, text) {
      const element = document.getElementById(elementId);
      element.textContent = text;
      element.style.display = 'block';
    }

    // Загрузка аллергенов из базы данных
    function loadAllergens() {
      const container = document.getElementById('spisok_allergenov');
      const loading = document.getElementById('allergensLoading');

      // Проверяем, не загружены ли уже аллергены
      if (container.children.length > 0) {
        loading.style.display = 'none';
        container.style.display = 'grid';
        return;
      }

      fetch('/api/ingredients')
        .then(response => {
          if (!response.ok) {
            throw new Error('Ошибка загрузки аллергенов');
          }
          return response.json();
        })
        .then(ingredients => {
          loading.style.display = 'none';

          if (ingredients.length === 0) {
            container.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #666;">Список продуктов пуст</p>';
            container.style.display = 'block';
            return;
          }

          let html = '';
          // Берем только первые 20 ингредиентов для удобства
          ingredients.slice(0, 20).forEach(ingredient => {
            html += `
              <label class="flazok">
                <input type="checkbox" name="allergen" value="${ingredient.id}">
                ${ingredient.name}
              </label>
            `;
          });

          container.innerHTML = html;
          container.style.display = 'grid';
        })
        .catch(error => {
          console.error('Ошибка загрузки аллергенов:', error);
          loading.innerHTML = '<p style="color: #f44336;">Не удалось загрузить список аллергенов</p>';
        });
    }

    // Обработка формы входа
    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const username = document.getElementById('login').value.trim();
      const password = document.getElementById('parol').value;

      // Валидация
      let hasError = false;

      if (!username) {
        showError('loginError', 'Введите логин или email');
        hasError = true;
      } else {
        document.getElementById('loginError').style.display = 'none';
      }

      if (!password) {
        showError('passwordError', 'Введите пароль');
        hasError = true;
      } else {
        document.getElementById('passwordError').style.display = 'none';
      }

      if (hasError) return;

      // Отправка запроса
      const button = this.querySelector('button[type="submit"]');
      const originalText = button.textContent;
      button.textContent = 'Вход...';
      button.disabled = true;

      fetch('/api/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          username: username,
          password: password
        })
      })
      .then(response => response.json())
      .then(data => {
        button.textContent = originalText;
        button.disabled = false;

        if (data.status === 'success') {
          showMessage('loginMessage', 'Успешный вход! Перенаправление...', 'success');
          setTimeout(() => {
            window.location.href = data.redirect;
          }, 1000);
        } else {
          showMessage('loginMessage', data.message || 'Неверный логин или пароль', 'error-message');
        }
      })
      .catch(error => {
        console.error('Ошибка входа:', error);
        button.textContent = originalText;
        button.disabled = false;
        showMessage('loginMessage', 'Ошибка соединения с сервером', 'error-message');
      });
    });

    // Обработка формы регистрации
    document.getElementById('regForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const name = document.getElementById('imya').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('novyy_parol').value;
      const confirmPassword = document.getElementById('povtor_parolya').value;

      // Получаем выбранные аллергены
      const allergenCheckboxes = document.querySelectorAll('#spisok_allergenov input[name="allergen"]:checked');
      const allergens = Array.from(allergenCheckboxes).map(cb => parseInt(cb.value));

      // Валидация
      let hasError = false;

      if (!name) {
        showError('nameError', 'Введите имя');
        hasError = true;
      } else {
        document.getElementById('nameError').style.display = 'none';
      }

      if (!email) {
        showError('emailError', 'Введите email');
        hasError = true;
      } else if (!/\S+@\S+\.\S+/.test(email)) {
        showError('emailError', 'Введите корректный email');
        hasError = true;
      } else {
        document.getElementById('emailError').style.display = 'none';
      }

      if (!password) {
        showError('passwordErrorReg', 'Введите пароль');
        hasError = true;
      } else if (password.length < 4) {
        showError('passwordErrorReg', 'Пароль должен быть не менее 4 символов');
        hasError = true;
      } else {
        document.getElementById('passwordErrorReg').style.display = 'none';
      }

      if (!confirmPassword) {
        showError('confirmPasswordError', 'Повторите пароль');
        hasError = true;
      } else if (password !== confirmPassword) {
        showError('confirmPasswordError', 'Пароли не совпадают');
        hasError = true;
      } else {
        document.getElementById('confirmPasswordError').style.display = 'none';
      }

      if (hasError) return;

      // Отправка запроса
      const button = document.getElementById('regButton');
      const originalText = button.textContent;
      button.textContent = 'Регистрация...';
      button.disabled = true;

      fetch('/api/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          username: name,
          email: email,
          password: password,
          confirm_password: confirmPassword,
          allergens: allergens
        })
      })
      .then(response => response.json())
      .then(data => {
        button.textContent = originalText;
        button.disabled = false;

        if (data.status === 'success') {
          showMessage('registerMessage', 'Регистрация успешна! Перенаправление...', 'success');
          setTimeout(() => {
            window.location.href = data.redirect;
          }, 1500);
        } else {
          showMessage('registerMessage', data.message || 'Ошибка регистрации', 'error-message');
        }
      })
      .catch(error => {
        console.error('Ошибка регистрации:', error);
        button.textContent = originalText;
        button.disabled = false;
        showMessage('registerMessage', 'Ошибка соединения с сервером', 'error-message');
      });
    });

    // Очистка ошибок при вводе
    document.querySelectorAll('.pole_vvoda').forEach(input => {
      input.addEventListener('input', function() {
        const errorId = this.id + 'Error';
        const errorElement = document.getElementById(errorId);
        if (errorElement) {
          errorElement.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>